version: 0.3.0
meta:
  id: state_machine_kairos
  owner: NeuroReturn™ Engineering
  updated_at: '2025-09-07'
  repo_path: 08-agents/KAIROS/state_machine.yaml
states:
  F0:
    desc: Dev / Recovery / Safety hold
  F1:
    desc: Stabilization / Integration
  F2:
    desc: Operational
  F3:
    desc: Production / Canon
initial: F1
guards:
  risk_override: 0.7
  risk_block: 0.8
  returnscore_min: 0.6
  approvals_required_for_F3: 1
transitions:
- from:
  - F0
  - F1
  - F2
  - F3
  to: F0
  when:
    any:
    - safety_gate.block: true
    - metric.risk_score:
        '>=': 0.8
    - metric.ReturnScore:
        <: 0.6
    - event.type: secret_leak
  actions:
  - set.authority: ARKHIVAR
  - run:
    - ci_protocols/validation_ci.yaml
    - ci_protocols/returnscore_eval.yaml
  - log: observability/logs/state_trace.yaml
- from: F0
  to: F1
  when:
    all:
    - ci_result: pass
    - metric.risk_score:
        <: 0.7
    - tpma_integrity: pass
  actions:
  - set.authority: KAIROS
  - log: observability/logs/state_trace.yaml
- from: F1
  to: F2
  when:
    all:
    - ci_result: pass
    - safety_docs_present: true
    - glossary_coverage:
        '>=': 0.8
    - metric.risk_score:
        <: 0.7
    - returnscore.outcome:
        in:
        - pass
        - warn
  actions:
  - set.authority: User
  - log: observability/logs/state_trace.yaml
- from: F2
  to: F3
  when:
    all:
    - ci_profile: prod
    - ci_result: pass
    - approvals_obtained:
        '>=': 1
    - metric.risk_score:
        <: 0.7
    - returnscore.outcome: pass
  actions:
  - set.authority: User
  - log: observability/logs/state_trace.yaml
- from: F1
  to: F0
  when:
    any:
    - ci_result: fail
    - safety_gate.block: true
  actions:
  - set.authority: ARKHIVAR
  - log: observability/logs/state_trace.yaml
- from: F2
  to: F1
  when:
    any:
    - ci_result: fail
    - metric.risk_score:
        '>=': 0.7
  actions:
  - set.authority: KAIROS
  - log: observability/logs/state_trace.yaml
- from: F3
  to: F2
  when:
    any:
    - ci_result: warn
    - metric.risk_score:
        '>=': 0.7
  actions:
  - set.authority: KAIROS
  - log: observability/logs/state_trace.yaml
notes:
- ci_result и returnscore берутся из ci_protocols/validation_ci.yaml и returnscore_eval.yaml
- safety_docs_present определяется в validation_ci.yaml (safety_content.scan)
- approvals_obtained проверяется против governance/authority_matrix.yaml
